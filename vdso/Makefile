ifeq ($(KERNELX_HOME),)
$(error KERNELX_HOME is not set)
endif

CC = $(CROSS_COMPILE)gcc

BUILD_DIR = build/$(ARCH)${ARCH_BITS}
VDSOLIB_BUILD_DIR = $(BUILD_DIR)/lib
VDSOLIB_TARGET = $(VDSOLIB_BUILD_DIR)/libvdso.so
SYM_TARGET = $(BUILD_DIR)/symbols.inc
OBJ_TARGET = $(BUILD_DIR)/vdso.o

CMAKE_DEFINITIONS += ARCH=$(ARCH)
CMAKE_DEFINITIONS += ARCH_BITS=$(ARCH_BITS)
CMAKE_DEFINITIONS += KERNELX_HOME=$(KERNELX_HOME)
CMAKE_DEFINITIONS += CROSS_COMPILE=$(CROSS_COMPILE)
CMAKE_FLAGS += $(addprefix -D, $(CMAKE_DEFINITIONS))

all: $(OBJ_TARGET)

$(OBJ_TARGET): $(VDSOLIB_TARGET) $(SYM_TARGET)
	@ mkdir -p $(BUILD_DIR)
	@ $(CC) $(CFLAGS) $(ARCH_COMMON_FLAGS) -c vdso.S -o $@ -DVDSO=\"$(VDSOLIB_TARGET)\"

$(VDSOLIB_TARGET):
	@ mkdir -p $(VDSOLIB_BUILD_DIR)
	@ cmake -B $(VDSOLIB_BUILD_DIR) $(CMAKE_FLAGS)
	@ cmake --build $(VDSOLIB_BUILD_DIR)

$(SYM_TARGET): $(VDSOLIB_TARGET)
	@ python3 scripts/symbols.py --input $< --output $@

clean:
	@ rm -rf $(BUILD_DIR)

.PHONY: all elf