# 启动步骤

## 体系结构早期启动

KernelX 的内核入口位于 `clib/src/arch/{arch}` 文件夹下代码中的 `_entry` 符号。早期启动大致分为两部分：一部分是纯汇编完成的最小环境搭建，另一部分是在 C 里实现的。

对于启动核，首先，内核通过记录入口的PC，假定这个地址就是内核可以使用的内存的起始地址，并与符号表中的 `_entry` 地址进行对比，计算得到加载地址和运行地址的偏移量。之后，内核会设置早期栈空间，在C代码中清空BSS段，然后读取设备树信息，得到内存布局信息，获取可用内存的结束地址。通过起始地址和结束地址，将整个内核映射到加载地址的虚拟地址空间中（通常是高地址），并开启分页功能。最后，内核会进入下一级启动流程。内核将内核页表、可用的堆起始地址、内核地址偏移等信息传递给下一级启动流程。

## 二级启动和内核初始化

1. 根据配置中的堆大小，划分堆和页面分配区域，初始化堆分配器和页面分配器。

2. 初始化驱动子系统，注册所有的驱动匹配器，以便后续匹配驱动。

3. 特定体系结构初始化，包括了设置中断向量、映射跳板代码、添加特定的驱动等等。

4. 初始化文件系统，包括注册文件系统类型、初始化特定文件系统如 `devfs` 等。

5. 发现设备。体系结构相关代码将发现的设备传递给 driver 子系统，driver 子系统根据设备信息和已注册的驱动匹配器，匹配并初始化设备驱动。

6. 初始化页面交换模块，初始化特定的交换设备。

7. 根据传入的内核启动参数，挂载根文件系统，同时挂载 `devfs` 到 `/dev` 目录、 `procfs` 到 `/proc` 目录。并启动 init 进程作为1号进程，启动kswapd内核线程。

8. 初始化完毕，唤醒其他核，进入线程调度器，开始调度用户态进程运行。
